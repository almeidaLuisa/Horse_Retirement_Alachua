<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Audit Trail — The Retirement Home for Horses, Inc.</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet"/>

    <style>
      :root {
        --green-light: #e8f5e9;
        --green-mid:   #81c784;
        --green-dark:  #388e3c;
        --blue-light:  #e0f7fa;
        --blue-dark:   #00796b;
        --text-dark:   #263238;
        --text-muted:  #546e7a;
        --card-shadow: 0 4px 16px rgba(0,0,0,0.08);
      }

      * { box-sizing: border-box; margin: 0; padding: 0; }

      body {
        font-family: 'Nunito', sans-serif;
        color: var(--text-dark);
        background: linear-gradient(170deg, var(--green-light) 0%, #f5faf6 40%, var(--blue-light) 100%);
        min-height: 100vh;
      }

      /* ── Top bar ── */
      .top-bar {
        background: linear-gradient(90deg, var(--green-dark), var(--blue-dark));
        padding: 0.65rem 1.5rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-shadow: 0 2px 12px rgba(0,0,0,0.15);
        position: sticky;
        top: 0;
        z-index: 100;
      }
      .top-bar .brand {
        color: #fff;
        font-weight: 800;
        font-size: 1.15rem;
        text-decoration: none;
      }
      .top-bar .brand:hover { opacity: 0.9; }
      .top-bar-right {
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }
      .back-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.35rem 0.85rem;
        border-radius: 8px;
        font-weight: 700;
        font-size: 0.85rem;
        text-decoration: none;
        border: 1.5px solid rgba(255,255,255,0.5);
        color: #fff;
        background: rgba(255,255,255,0.12);
        transition: background 0.2s;
      }
      .back-btn:hover { background: rgba(255,255,255,0.25); color: #fff; }

      /* ── Page header ── */
      .page-header {
        background: linear-gradient(rgba(0,60,40,0.55), rgba(0,80,80,0.55)),
                    url('images/Emmett & June.jpg') center/cover no-repeat;
        padding: 2rem 2rem 1.5rem;
        color: #fff;
      }
      .page-header h1 {
        font-weight: 800;
        font-size: 1.5rem;
        text-shadow: 0 2px 8px rgba(0,0,0,0.3);
      }
      .page-header p {
        opacity: 0.9;
        font-size: 0.92rem;
        margin-top: 0.25rem;
      }

      /* ── Search bar ── */
      .search-wrapper {
        max-width: 900px;
        margin: -1.25rem auto 0;
        padding: 0 1.5rem;
        position: relative;
        z-index: 10;
      }
      .search-box {
        display: flex;
        align-items: center;
        gap: 0.6rem;
        background: #fff;
        border-radius: 12px;
        box-shadow: var(--card-shadow);
        padding: 0.7rem 1.1rem;
      }
      .search-box i { color: var(--text-muted); font-size: 1.1rem; }
      .search-box input {
        border: none;
        outline: none;
        flex: 1;
        font-family: 'Nunito', sans-serif;
        font-size: 0.95rem;
        color: var(--text-dark);
      }
      .search-box input::placeholder { color: #b0bec5; }
      .search-count {
        font-size: 0.8rem;
        font-weight: 700;
        color: var(--text-muted);
        white-space: nowrap;
      }

      /* ── Content area ── */
      .content-area {
        max-width: 900px;
        margin: 1.25rem auto;
        padding: 0 1.5rem 2rem;
      }
      .audit-card {
        background: #fff;
        border-radius: 12px;
        box-shadow: var(--card-shadow);
        overflow: hidden;
      }
      .audit-card-body {
        padding: 0.5rem 1.25rem 1.25rem;
      }

      /* ── List items ── */
      .item-row {
        display: flex;
        align-items: flex-start;
        gap: 0.7rem;
        padding: 0.65rem 0;
        border-bottom: 1px solid #eceff1;
      }
      .item-row:last-child { border-bottom: none; }
      .item-row.hidden { display: none; }

      .item-icon {
        width: 32px; height: 32px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.95rem;
        flex-shrink: 0;
      }

      .item-text { flex: 1; }
      .item-text .title {
        font-weight: 700;
        font-size: 0.92rem;
        color: var(--text-dark);
      }
      .item-text .meta {
        font-size: 0.8rem;
        color: var(--text-muted);
      }

      .empty-state {
        text-align: center;
        padding: 2rem 1rem;
        color: var(--text-muted);
      }
      .empty-state i { font-size: 2rem; display: block; margin-bottom: 0.5rem; opacity: 0.5; }
    </style>
  </head>

  <body>
    <!-- ── Top Bar ── -->
    <div class="top-bar">
      <a href="dashboard_page.html" class="brand">
        <i class="bi bi-tree-fill"></i> Horse Retirement
      </a>
      <div class="top-bar-right">
        <a href="dashboard_page.html" class="back-btn">
          <i class="bi bi-arrow-left"></i> Back to Dashboard
        </a>
      </div>
    </div>

    <!-- ── Page Header ── -->
    <div class="page-header">
      <h1><i class="bi bi-journal-text"></i> Audit Trail</h1>
      <p>Search and review all system activity logs</p>
    </div>

    <!-- ── Search Bar ── -->
    <div class="search-wrapper">
      <div class="search-box">
        <i class="bi bi-search"></i>
        <input type="text" id="searchInput" placeholder="Search audits by action, user, details..." autofocus />
        <span class="search-count" id="searchCount"></span>
      </div>
    </div>

    <!-- ── Audit Logs ── -->
    <div class="content-area">
      <div class="audit-card">
        <div class="audit-card-body" id="auditList">
          <div class="empty-state">
            <i class="bi bi-hourglass-split"></i>
            Loading audit logs...
          </div>
        </div>
      </div>
    </div>

    <script>
      const API_URL = 'http://127.0.0.1:5000';

      // Load all audits on page load
      document.addEventListener('DOMContentLoaded', () => {
        loadAudits();
        document.getElementById('searchInput').addEventListener('input', filterAudits);
      });

      let allRows = []; // store references for filtering

      async function loadAudits() {
        try {
          const res = await fetch(`${API_URL}/api/audits`);
          const audits = await res.json();

          const container = document.getElementById('auditList');
          container.innerHTML = '';

          if (!audits.length) {
            container.innerHTML = '<div class="empty-state"><i class="bi bi-inbox"></i>No audit entries yet.</div>';
            updateCount(0, 0);
            return;
          }

          allRows = [];

          audits.forEach(audit => {
            // Pick icon based on action type
            let iconClass = 'bi bi-journal-text';
            let iconBg = 'background:#e3f2fd; color:#1565c0;';
            const action = (audit.action || '').toUpperCase();

            if (action.includes('LOGIN')) {
              iconClass = 'bi bi-box-arrow-in-right';
              iconBg = 'background:#e8f5e9; color:#388e3c;';
            } else if (action.includes('REGISTER') || action.includes('CREATE')) {
              iconClass = 'bi bi-person-plus-fill';
              iconBg = 'background:#f3e5f5; color:#7b1fa2;';
            } else if (action.includes('UPDATE') || action.includes('EDIT')) {
              iconClass = 'bi bi-pencil-square';
              iconBg = 'background:#fff3e0; color:#e65100;';
            } else if (action.includes('DELETE')) {
              iconClass = 'bi bi-trash-fill';
              iconBg = 'background:#ffebee; color:#c62828;';
            }

            // Format timestamp
            let timeStr = '';
            if (audit.timestamp) {
              const d = new Date(audit.timestamp);
              timeStr = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) + ' ' +
                        d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            }

            // Build details string
            let detailStr = audit.action || 'Unknown action';
            if (audit.details) {
              if (typeof audit.details === 'string') {
                detailStr += ' — ' + audit.details;
              } else if (audit.details.email) {
                detailStr += ' — ' + audit.details.email;
              } else if (audit.details.horse_name) {
                detailStr += ' — ' + audit.details.horse_name;
              }
            }

            // Searchable text (lowercase) for filtering
            const searchText = [
              detailStr,
              audit.table || '',
              audit.user_id || '',
              timeStr
            ].join(' ').toLowerCase();

            const row = document.createElement('div');
            row.className = 'item-row';
            row.dataset.search = searchText;
            row.innerHTML = `
              <div class="item-icon" style="${iconBg}"><i class="${iconClass}"></i></div>
              <div class="item-text">
                <div class="title">${detailStr}</div>
                <div class="meta">
                  ${audit.table ? 'Table: ' + audit.table + ' &bull; ' : ''}${timeStr}
                  ${audit.user_id ? ' &bull; User: ' + audit.user_id : ''}
                </div>
              </div>`;

            container.appendChild(row);
            allRows.push(row);
          });

          updateCount(allRows.length, allRows.length);

        } catch (e) {
          console.error('Error loading audits:', e);
          document.getElementById('auditList').innerHTML =
            '<div class="empty-state"><i class="bi bi-exclamation-triangle"></i>Could not load audit trail.</div>';
        }
      }

      function filterAudits() {
        const query = document.getElementById('searchInput').value.toLowerCase().trim();
        let visible = 0;

        allRows.forEach(row => {
          if (!query || row.dataset.search.includes(query)) {
            row.classList.remove('hidden');
            visible++;
          } else {
            row.classList.add('hidden');
          }
        });

        updateCount(visible, allRows.length);
      }

      function updateCount(visible, total) {
        const el = document.getElementById('searchCount');
        if (visible === total) {
          el.textContent = total + ' entries';
        } else {
          el.textContent = visible + ' of ' + total + ' entries';
        }
      }
    </script>
  </body>
</html>
