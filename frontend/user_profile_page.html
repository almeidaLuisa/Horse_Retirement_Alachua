<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Profile — Horse Retirement Alachua</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet"/>
    <style>
      :root {
        --primary-green: #9CD479;
        --primary-blue: #79AED4;
        --bg-color: #f8f9fa;
      }
      body {
        background-color: var(--bg-color);
        font-family: 'Nunito', sans-serif;
      }
      .navbar {
        background: white;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      }
      .navbar-brand {
        font-weight: 800;
        color: var(--primary-green);
      }
      .profile-header {
        background: linear-gradient(135deg, var(--primary-green) 0%, var(--primary-blue) 100%);
        color: white;
        padding: 3rem 0;
        margin-bottom: 2rem;
        border-radius: 0 0 20px 20px;
      }
      .profile-card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.05);
        overflow: hidden;
      }
      .form-control:disabled {
        background-color: #f8f9fa;
        opacity: 1;
        border-color: #eee;
      }
      .d-none { display: none !important; }
    </style>
  </head>
  <body>

    <nav class="navbar navbar-expand-lg navbar-light fixed-top">
      <div class="container">
        <a class="navbar-brand" href="dashboard_page.html"><img src="images/Horse_logo.jpg" alt="Logo" height="40" style="border-radius:8px;"></a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item"><a class="nav-link" href="dashboard_page.html">Dashboard</a></li>
            <li class="nav-item"><a class="nav-link active" href="#">Profile</a></li>
            <li class="nav-item">
                <a class="nav-link text-danger fw-bold" href="#" onclick="logout()">
                    <i class="bi bi-box-arrow-right"></i> Log Out
                </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <header class="profile-header text-center mt-5 pt-5">
      <div class="container">
        <h1 class="display-5 fw-bold" id="welcomeMsg">Welcome!</h1>
        <p class="lead">Manage your account settings below</p>
      </div>
    </header>

    <div class="container mb-5">
      <div class="row justify-content-center">
        <div class="col-md-8">
          
          <div id="viewerAlert" class="alert alert-info d-none" role="alert">
            <i class="bi bi-eye-fill me-2"></i> You have <strong>Viewer</strong> permissions. You can browse horses and observations but cannot make changes.
          </div>

          <div id="editorAlert" class="alert alert-warning d-none" role="alert">
            <i class="bi bi-pencil-fill me-2"></i> You have <strong>Editor</strong> permissions. You can add/edit horses and manage observations.
          </div>

          <div id="adminAlert" class="alert alert-success d-none" role="alert">
            <i class="bi bi-shield-fill-check me-2"></i> You have <strong>Admin</strong> permissions. You have full access to all features.
          </div>

          <div class="card profile-card p-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h4 class="mb-0 text-secondary"><i class="bi bi-person-lines-fill me-2"></i>Account Details</h4>
              <div>
                <button class="btn btn-outline-primary btn-sm" id="btnEdit" onclick="enableEditing()"><i class="bi bi-pencil me-1"></i>Edit</button>
                <button class="btn btn-success btn-sm d-none" id="btnSave" onclick="saveProfile()"><i class="bi bi-check-lg me-1"></i>Save</button>
                <button class="btn btn-outline-secondary btn-sm d-none" id="btnCancel" onclick="cancelEditing()"><i class="bi bi-x-lg me-1"></i>Cancel</button>
              </div>
            </div>
            <div id="saveStatus" class="alert d-none mb-3"></div>
            
            <form>
              <div class="row mb-3">
                <div class="col-md-6">
                  <label class="form-label text-muted small">First Name</label>
                  <input type="text" class="form-control" id="firstName" disabled>
                </div>
                <div class="col-md-6">
                  <label class="form-label text-muted small">Last Name</label>
                  <input type="text" class="form-control" id="lastName" disabled>
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label text-muted small">Email Address</label>
                <input type="email" class="form-control" id="email" disabled>
              </div>

              <div class="row mb-3">
                <div class="col-md-6">
                  <label class="form-label text-muted small">Phone Number</label>
                  <input type="tel" class="form-control" id="phone" disabled>
                </div>
                <div class="col-md-6">
                  <label class="form-label text-muted small">Account Role</label>
                  <input type="text" class="form-control" id="role" disabled>
                </div>
              </div>

              <div class="row mb-3">
                 <div class="col-md-6">
                  <label class="form-label text-muted small">Status</label>
                  <input type="text" class="form-control" id="status" disabled>
                </div>
                 <div class="col-md-6">
                  <label class="form-label text-muted small">Member Since</label>
                  <input type="text" class="form-control" id="createdDate" disabled>
                </div>
              </div>

              <div class="row mb-3">
                <div class="col">
                  <label class="form-label text-muted small">Password</label>
                  <div class="d-flex align-items-center gap-2">
                    <input type="text" class="form-control" value="••••••••••" disabled style="letter-spacing:3px;font-weight:700;">
                    <a href="#changePasswordCard" class="btn btn-outline-primary btn-sm text-nowrap" onclick="document.getElementById('changePasswordCard').scrollIntoView({behavior:'smooth'})">
                      <i class="bi bi-pencil me-1"></i>Change
                    </a>
                  </div>
                </div>
              </div>

            </form>
          </div>

          <!-- Change Password Card -->
          <div class="card profile-card p-4 mt-4" id="changePasswordCard">
            <h4 class="mb-3 text-secondary"><i class="bi bi-lock-fill me-2"></i>Change Password</h4>
            <p class="text-muted small mb-4">Enter your current password and choose a new one.</p>
            <div id="pwStatus" class="alert d-none mb-3 small"></div>
            <form onsubmit="changePassword(event)">
              <div class="mb-3">
                <label class="form-label text-muted small">Current Password</label>
                <div class="input-group">
                  <input type="password" class="form-control" id="currentPw" required>
                  <button class="btn btn-outline-secondary" type="button" onclick="togglePw('currentPw', this)" tabindex="-1"><i class="bi bi-eye"></i></button>
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label text-muted small">New Password</label>
                <div class="input-group">
                  <input type="password" class="form-control" id="newPw" required minlength="6">
                  <button class="btn btn-outline-secondary" type="button" onclick="togglePw('newPw', this)" tabindex="-1"><i class="bi bi-eye"></i></button>
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label text-muted small">Confirm New Password</label>
                <div class="input-group">
                  <input type="password" class="form-control" id="confirmPw" required minlength="6">
                  <button class="btn btn-outline-secondary" type="button" onclick="togglePw('confirmPw', this)" tabindex="-1"><i class="bi bi-eye"></i></button>
                </div>
              </div>
              <div class="text-end">
                <button type="submit" class="btn btn-sm px-4 py-2 fw-bold" 
                  style="background:linear-gradient(135deg,var(--primary-green),var(--primary-blue));color:#fff;border:none;border-radius:10px;">
                  <i class="bi bi-shield-lock me-1"></i>Update Password
                </button>
              </div>
            </form>
          </div>

          <!-- Notifications Card -->
          <div class="card profile-card p-4 mt-4">
            <h4 class="mb-3 text-secondary"><i class="bi bi-bell-fill me-2"></i>Notification Preferences</h4>
            <p class="text-muted small mb-4">Choose which email notifications you'd like to receive.</p>

            <div class="d-flex justify-content-between align-items-center py-3 border-bottom">
              <div>
                <div class="fw-bold" style="font-size:0.95rem;"><i class="bi bi-clipboard2-check me-2 text-warning"></i>To-Do Reminders</div>
                <div class="text-muted small">Get reminded about upcoming or overdue to-do items</div>
              </div>
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="notifTodo" style="width:3rem;height:1.5rem;cursor:pointer;" checked>
              </div>
            </div>

            <div class="d-flex justify-content-between align-items-center py-3 border-bottom">
              <div>
                <div class="fw-bold" style="font-size:0.95rem;"><i class="bi bi-journal-text me-2 text-primary"></i>New Observations</div>
                <div class="text-muted small">Get notified when a new observation or note is added</div>
              </div>
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="notifObs" style="width:3rem;height:1.5rem;cursor:pointer;" checked>
              </div>
            </div>

            <div class="d-flex justify-content-between align-items-center py-3 border-bottom">
              <div>
                <div class="fw-bold" style="font-size:0.95rem;"><i class="bi bi-heart-pulse me-2 text-danger"></i>Horse Updates</div>
                <div class="text-muted small">Get notified when a horse record is added or updated</div>
              </div>
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="notifHorse" style="width:3rem;height:1.5rem;cursor:pointer;">
              </div>
            </div>

            <div class="d-flex justify-content-between align-items-center py-3">
              <div>
                <div class="fw-bold" style="font-size:0.95rem;"><i class="bi bi-shield-exclamation me-2 text-success"></i>Security Alerts</div>
                <div class="text-muted small">Get notified about logins and account changes</div>
              </div>
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="notifSecurity" style="width:3rem;height:1.5rem;cursor:pointer;" checked>
              </div>
            </div>

            <div class="mt-3 text-end">
              <button class="btn btn-sm px-4 py-2 fw-bold" id="btnSaveNotifs" onclick="saveNotifPrefs()" 
                style="background:linear-gradient(135deg,var(--primary-green),var(--primary-blue));color:#fff;border:none;border-radius:10px;">
                <i class="bi bi-check-lg me-1"></i>Save Preferences
              </button>
              <div id="notifStatus" class="alert d-none mt-2 mb-0 small"></div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const API_URL = "/api/user/profile";

      // 1. SECURITY CHECK
      const userEmail = localStorage.getItem('user_email');
      
      if (!userEmail) {
          window.location.href = 'home_page.html';
      }

      // 2. FETCH DATA
      async function loadProfile() {
          try {
              const response = await fetch(`${API_URL}?email=${userEmail}`);
              const data = await response.json();

              if (response.ok) {
                  // Welcome Message
                  const displayName = data.first_name ? 
                      `${data.first_name} ${data.last_name}` : 
                      data.email;
                  document.getElementById('welcomeMsg').innerText = `Welcome, ${displayName}!`;
                  
                  // Populate Fields
                  document.getElementById('firstName').value = data.first_name || '';
                  document.getElementById('lastName').value = data.last_name || '';
                  document.getElementById('email').value = data.email || '';
                  document.getElementById('phone').value = data.phone || '';
                  document.getElementById('role').value = (data.role || 'User').toUpperCase();
                  document.getElementById('status').value = data.is_active ? 'Active' : 'Inactive';
                  
                  if (data.created_at) {
                      const date = new Date(data.created_at);
                      document.getElementById('createdDate').value = date.toLocaleDateString();
                  }

                  // Permissions Alert
                  const role = (data.role || '').toLowerCase();
                  if (role === 'user' || role === 'viewer') {
                      document.getElementById('viewerAlert').classList.remove('d-none');
                  } else if (role === 'editor') {
                      document.getElementById('editorAlert').classList.remove('d-none');
                  } else if (role === 'admin') {
                      document.getElementById('adminAlert').classList.remove('d-none');
                  }

              } else {
                  console.error("Profile load failed:", data.error);
              }
          } catch (error) {
              console.error("Connection error:", error);
          }
      }

      // 3. EDIT PROFILE
      let originalValues = {};

      function enableEditing() {
          // Save original values for cancel
          originalValues = {
              firstName: document.getElementById('firstName').value,
              lastName: document.getElementById('lastName').value,
              phone: document.getElementById('phone').value
          };
          // Enable editable fields
          document.getElementById('firstName').disabled = false;
          document.getElementById('lastName').disabled = false;
          document.getElementById('phone').disabled = false;
          // Toggle buttons
          document.getElementById('btnEdit').classList.add('d-none');
          document.getElementById('btnSave').classList.remove('d-none');
          document.getElementById('btnCancel').classList.remove('d-none');
      }

      function cancelEditing() {
          // Restore original values
          document.getElementById('firstName').value = originalValues.firstName;
          document.getElementById('lastName').value = originalValues.lastName;
          document.getElementById('phone').value = originalValues.phone;
          // Disable fields
          document.getElementById('firstName').disabled = true;
          document.getElementById('lastName').disabled = true;
          document.getElementById('phone').disabled = true;
          // Toggle buttons
          document.getElementById('btnEdit').classList.remove('d-none');
          document.getElementById('btnSave').classList.add('d-none');
          document.getElementById('btnCancel').classList.add('d-none');
          document.getElementById('saveStatus').classList.add('d-none');
      }

      async function saveProfile() {
          const updatedData = {
              email: userEmail,
              first_name: document.getElementById('firstName').value.trim(),
              last_name: document.getElementById('lastName').value.trim(),
              phone: document.getElementById('phone').value.trim()
          };

          const statusEl = document.getElementById('saveStatus');
          try {
              const response = await fetch(API_URL, {
                  method: 'PUT',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(updatedData)
              });
              const data = await response.json();
              if (response.ok) {
                  statusEl.className = 'alert alert-success mb-3';
                  statusEl.innerText = 'Profile updated successfully!';
                  statusEl.classList.remove('d-none');
                  // Update localStorage name
                  localStorage.setItem('user_name', updatedData.first_name);
                  // Update welcome message
                  document.getElementById('welcomeMsg').innerText = `Welcome, ${updatedData.first_name} ${updatedData.last_name}!`;
                  // Disable fields & toggle buttons
                  document.getElementById('firstName').disabled = true;
                  document.getElementById('lastName').disabled = true;
                  document.getElementById('phone').disabled = true;
                  document.getElementById('btnEdit').classList.remove('d-none');
                  document.getElementById('btnSave').classList.add('d-none');
                  document.getElementById('btnCancel').classList.add('d-none');
                  setTimeout(() => statusEl.classList.add('d-none'), 3000);
              } else {
                  statusEl.className = 'alert alert-danger mb-3';
                  statusEl.innerText = data.error || 'Update failed.';
                  statusEl.classList.remove('d-none');
              }
          } catch (err) {
              console.error(err);
              statusEl.className = 'alert alert-danger mb-3';
              statusEl.innerText = 'Server error. Is the Flask server running?';
              statusEl.classList.remove('d-none');
          }
      }

      // 4. LOGOUT
      function logout() {
          localStorage.removeItem('user_name');
          localStorage.removeItem('user_email');
          localStorage.removeItem('user_role');
          window.location.href = 'home_page.html';
      }

      // 5. CHANGE PASSWORD
      function togglePw(fieldId, btn) {
          const input = document.getElementById(fieldId);
          const icon = btn.querySelector('i');
          if (input.type === 'password') {
              input.type = 'text';
              icon.className = 'bi bi-eye-slash';
          } else {
              input.type = 'password';
              icon.className = 'bi bi-eye';
          }
      }

      async function changePassword(e) {
          e.preventDefault();
          const statusEl = document.getElementById('pwStatus');
          const currentPw = document.getElementById('currentPw').value;
          const newPw = document.getElementById('newPw').value;
          const confirmPw = document.getElementById('confirmPw').value;

          if (newPw.length < 6) {
              statusEl.className = 'alert alert-danger mb-3 small';
              statusEl.innerText = 'New password must be at least 6 characters.';
              statusEl.classList.remove('d-none');
              return;
          }
          if (newPw !== confirmPw) {
              statusEl.className = 'alert alert-danger mb-3 small';
              statusEl.innerText = 'New passwords do not match.';
              statusEl.classList.remove('d-none');
              return;
          }

          try {
              const response = await fetch('/api/user/change-password', {
                  method: 'PUT',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                      email: userEmail,
                      current_password: currentPw,
                      new_password: newPw
                  })
              });
              const data = await response.json();
              if (response.ok) {
                  statusEl.className = 'alert alert-success mb-3 small';
                  statusEl.innerText = 'Password changed successfully!';
                  document.getElementById('currentPw').value = '';
                  document.getElementById('newPw').value = '';
                  document.getElementById('confirmPw').value = '';
              } else {
                  statusEl.className = 'alert alert-danger mb-3 small';
                  statusEl.innerText = data.error || 'Failed to change password.';
              }
              statusEl.classList.remove('d-none');
              setTimeout(() => statusEl.classList.add('d-none'), 5000);
          } catch (err) {
              console.error(err);
              statusEl.className = 'alert alert-danger mb-3 small';
              statusEl.innerText = 'Server error. Is the Flask server running?';
              statusEl.classList.remove('d-none');
          }
      }

      // 6. NOTIFICATION PREFERENCES (frontend-only for now)
      function loadNotifPrefs() {
          const prefs = JSON.parse(localStorage.getItem('notif_prefs') || '{}');
          document.getElementById('notifTodo').checked = prefs.todo !== false;       // default on
          document.getElementById('notifObs').checked = prefs.obs !== false;         // default on
          document.getElementById('notifHorse').checked = prefs.horse === true;      // default off
          document.getElementById('notifSecurity').checked = prefs.security !== false; // default on
      }

      function saveNotifPrefs() {
          const prefs = {
              todo: document.getElementById('notifTodo').checked,
              obs: document.getElementById('notifObs').checked,
              horse: document.getElementById('notifHorse').checked,
              security: document.getElementById('notifSecurity').checked
          };
          localStorage.setItem('notif_prefs', JSON.stringify(prefs));

          const statusEl = document.getElementById('notifStatus');
          statusEl.className = 'alert alert-success mt-2 mb-0 small';
          statusEl.innerText = 'Notification preferences saved!';
          statusEl.classList.remove('d-none');
          setTimeout(() => statusEl.classList.add('d-none'), 3000);
      }

      // Start
      if (userEmail) { loadProfile(); loadNotifPrefs(); }
    </script>
  </body>
</html>